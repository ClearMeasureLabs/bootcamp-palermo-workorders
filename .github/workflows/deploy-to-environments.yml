name: Deploy to Environments
run-name: "Deploy ${{ inputs.release_number || format('1.3.{0}', github.event.workflow_run.run_number) }}"
on:
  workflow_run:
    workflows: ["Integration Build"]
    types: [completed]
    branches: ['master', 'main']
  workflow_dispatch:
    inputs:
      release_number:
        description: 'Release version to deploy (must match an existing Integration Build version, e.g. 1.3.394)'
        required: true
        type: string
env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  deploy-to-uat:
    name: UAT
    # Only deploy on push-triggered builds (not manual workflow_dispatch of the build workflow)
    # or when this workflow is manually dispatched with a release_number
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')
    runs-on: ubuntu-latest
    environment:
      name: UAT

    steps:
      - name: Set Version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ inputs.release_number }}"
          else
            version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.event.workflow_run.run_number }}"
          fi
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Deploy version: $version"

      - name: Deploy Octopus Release to UAT
        uses: OctopusDeploy/deploy-release-action@v3
        id: start-deploy-to-uat
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          project: ${{ vars.OCTOPUS_PROJECT }}
          release_number: ${{ env.BUILD_BUILDNUMBER }}
          environments: "UAT"

      - name: Wait for the UAT deployment to complete
        uses: OctopusDeploy/await-task-action@v3
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          server_task_id: ${{ fromJson(steps.start-deploy-to-uat.outputs.server_tasks)[0].serverTaskId }}
          timeout_after: 1800

  deploy-to-prod:
    name: Prod
    needs: [deploy-to-uat]
    if: success()
    runs-on: ubuntu-latest
    environment:
      name: Prod

    steps:
      - name: Set Version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ inputs.release_number }}"
          else
            version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.event.workflow_run.run_number }}"
          fi
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Deploy version: $version"

      - name: Deploy Octopus Release to Prod
        uses: OctopusDeploy/deploy-release-action@v3
        id: start-deploy-to-prod
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          project: ${{ vars.OCTOPUS_PROJECT }}
          release_number: ${{ env.BUILD_BUILDNUMBER }}
          environments: "Prod"

      - name: Wait for the Prod deployment to complete
        uses: OctopusDeploy/await-task-action@v3
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          server_task_id: ${{ fromJson(steps.start-deploy-to-prod.outputs.server_tasks)[0].serverTaskId }}
          timeout_after: 1800
