name: Deploy to Environments
run-name: "Deploy 1.3.${{ github.event.workflow_run.run_number || github.run_number }} to UAT & Prod"
on:
  workflow_run:
    workflows: ["Integration Build"]
    types: [completed]
    branches: ['master', 'main']
  workflow_dispatch:
    inputs:
      release_number:
        description: 'Release number to deploy (e.g., 1.3.123). If not provided, uses the current run number.'
        required: false
        type: string
env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  deploy-to-uat:
    name: UAT
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: UAT

    steps:
      - name: Set Version
        run: |
          if [ -n "${{ inputs.release_number }}" ]; then
            version="${{ inputs.release_number }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.event.workflow_run.run_number }}"
          else
            version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          fi
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      - name: Deploy Octopus Release to UAT
        uses: OctopusDeploy/deploy-release-action@v3
        id: start-deploy-to-uat
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          project: ${{ vars.OCTOPUS_PROJECT }}
          release_number: ${{ env.BUILD_BUILDNUMBER }}
          environments: "UAT"

      - name: Wait for the UAT deployment to complete
        uses: OctopusDeploy/await-task-action@v3
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY  }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          server_task_id: ${{ fromJson(steps.start-deploy-to-uat.outputs.server_tasks)[0].serverTaskId }}
          timeout_after: 1800

  deploy-to-prod:
    name: Prod
    needs: [deploy-to-uat]
    if: success()
    runs-on: ubuntu-latest
    environment:
      name: Prod

    steps:
      - name: Set Version
        run: |
          if [ -n "${{ inputs.release_number }}" ]; then
            version="${{ inputs.release_number }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.event.workflow_run.run_number }}"
          else
            version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          fi
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      - name: Deploy Octopus Release to Prod
        uses: OctopusDeploy/deploy-release-action@v3
        id: start-deploy-to-prod
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          project: ${{ vars.OCTOPUS_PROJECT }}
          release_number: ${{ env.BUILD_BUILDNUMBER }}
          environments: "Prod"

      - name: Wait for the Prod deployment to complete
        uses: OctopusDeploy/await-task-action@v3
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY  }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          server_task_id: ${{ fromJson(steps.start-deploy-to-prod.outputs.server_tasks)[0].serverTaskId }}
          timeout_after: 1800
