name: Deploy to UAT
run-name: "1.3.${{ github.run_number }} â€¢ Deploy to UAT ${{ github.event.pull_request.title != '' && github.event.pull_request.title || github.head_ref || github.ref_name }}"
on:
  workflow_run:
    workflows: [ "Integration Build" ]
    types: [ completed ]
  workflow_dispatch:
concurrency:
  group: deploy-to-uat-${{ github.ref }}
  cancel-in-progress: true
env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  deploy-to-uat:
    name: UAT
    # Gate on successful completion of the Integration Build workflow or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment:
      name: UAT
    
    steps:
      - name: Retrieve build version from the Integration Build workflow
        uses: actions/download-artifact@v4
        with:
          name: churchbulletin-nuget-packages
          run-id: ${{ github.event.workflow_run.id }}

      - name: Set Version
        run: |
          version=$(cat build_version.txt)
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-version
          path: |
            build_version.txt
          retention-days: 90 

      - name: Deploy Octopus Release to UAT
        uses: OctopusDeploy/deploy-release-action@v3
        id: start-deploy-to-uat
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          project: ${{ vars.OCTOPUS_PROJECT }}   
          release_number: ${{ env.BUILD_BUILDNUMBER }}
          environments: "UAT"

      - name: Wait for the UAT deployment to complete
        uses: OctopusDeploy/await-task-action@v3
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY  }}
          OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
          OCTOPUS_SPACE: ${{ vars.OCTOPUS_SPACE }}
        with:
          server_task_id: ${{ fromJson(steps.start-deploy-to-uat.outputs.server_tasks)[0].serverTaskId }}
          timeout_after: 1800          
