name: Integration Build

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  build:
    name: Build and Test (Windows)
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
    env:
      BUILD_CONFIGURATION: Release
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Start SQL Server LocalDB
      - name: Start SQL Server LocalDB
        shell: powershell
        run: |
          Write-Host "Starting SQL Server LocalDB..."
          sqllocaldb create MSSQLLocalDB
          sqllocaldb start MSSQLLocalDB
          sqllocaldb info MSSQLLocalDB

      # Install .NET SDK 9.0.302
      - name: Setup .NET SDK 9.0.302
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.302'

      # Set version environment variable
      - name: Set Version
        shell: pwsh
        run: |
          $version = "${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "Version=$version" >> $env:GITHUB_ENV
          Write-Host "Build version: $version"

      # Authenticate with GitHub Packages
      - name: Authenticate with GitHub Packages
        run: |
          # The --store-password-in-clear-text flag is required for CI/CD environments.
          # GitHub Actions runners are ephemeral and isolated, and the GITHUB_TOKEN is short-lived and scoped.
          # This stores the token unencrypted on the agent, which is acceptable in this context.
          dotnet nuget add source --username ${{ github.repository_owner }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"

      # Run PrivateBuild script
      - name: Run Build Script
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          . ./build.ps1
          CIBuild

      # Publish test results
      - name: Test Reporter
        uses: dorny/test-reporter@v2.1.1
        if: always()
        with:
          name: CI Test Results
          path: 'build/test/**/*.trx'
          reporter: dotnet-trx

      # Publish code coverage
      - name: Publish Code Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/build/test/**/In/**/coverage.cobertura.xml'
          flags: unittests
          name: codecov-umbrella

      # Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/test/**/*.trx
          retention-days: 30

      # Upload code coverage as artifacts
      - name: Upload Code Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage
          path: '**/build/test/**/In/**/coverage.cobertura.xml'
          retention-days: 30

      # Upload build logs as artifacts
      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            build/**/*.log
            build/**/*.binlog
          retention-days: 30

  build-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      BUILD_CONFIGURATION: Release
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK 9.0.302
      - name: Setup .NET SDK 9.0.302
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.302'

      # Set version environment variable
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

       # Run CIBuild script
      - name: Run CI Build Script
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          . ./build.ps1
          CIBuild

      # Publish test results
      - name: Test Reporter
        uses: dorny/test-reporter@v2.1.1
        if: always()
        with:
          name: Linux CI Test Results
          path: 'build/test/**/*.trx'
          reporter: dotnet-trx

      # Publish code coverage
      - name: Publish Code Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/build/test/**/In/**/coverage.cobertura.xml'
          flags: unittests-linux
          name: codecov-linux

      # Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-linux
          path: build/test/**/*.trx
          retention-days: 30

      # Upload code coverage as artifacts
      - name: Upload Code Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage-linux
          path: '**/build/test/**/In/**/coverage.cobertura.xml'
          retention-days: 30

  acceptance-tests-and-publish:
    name: Acceptance Tests and Package
    runs-on: ubuntu-latest
    needs: [build, build-linux]
    if: success()
    permissions:
      contents: read
      packages: write
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK 9.0.302
      - name: Setup .NET SDK 9.0.302
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.302'

      # Install .NET SDK 6.0 (required by Octopus CLI)
      - name: Setup .NET SDK 6.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # Set version environment variable
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      # Install Playwright Browsers
      - name: Install Playwright Browsers
        shell: pwsh
        run: |
          $playwrightScript = Join-Path "src" "AcceptanceTests" "bin" "Release" "net9.0" "playwright.ps1"
          if (-not (Test-Path $playwrightScript)) {
            Write-Error "Playwright script not found at $playwrightScript"
            exit 1
          }
          pwsh $playwrightScript install --with-deps

      # Run Acceptance Tests
      - name: Run Acceptance Tests
        shell: pwsh
        env:
          BuildConfiguration: Release
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          .\AcceptanceTests.ps1

      # Package Everything
      - name: Package NuGet Packages
        shell: pwsh
        env:
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          . ./build.ps1
          Package-Everything

      # Upload packages as artifacts
      - name: Upload NuGet Packages
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nuget-packages-acceptance
          path: build/*.nupkg
          retention-days: 90

      # Upload test results
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-acceptance
          path: build/test/**/*.trx
          retention-days: 30
