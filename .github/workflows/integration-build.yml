name: Integration Build

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Start SQL Server LocalDB
      - name: Start SQL Server LocalDB
        shell: powershell
        run: |
          Write-Host "Starting SQL Server LocalDB..."
          sqllocaldb create MSSQLLocalDB
          sqllocaldb start MSSQLLocalDB
          sqllocaldb info MSSQLLocalDB

      # Install .NET SDK 9.0.302
      - name: Setup .NET SDK 9.0.302
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.302'

      # Set version environment variable
      - name: Set Version
        shell: powershell
        run: |
          $version = "${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "Version=$version" >> $env:GITHUB_ENV
          Write-Host "Build version: $version"

      # Run build script
      - name: Run Build Script
        shell: powershell
        run: |
          . ./build.ps1
          PrivateBuild

      # Publish test results
      - name: Test Reporter
        uses: dorny/test-reporter@v2.1.1
        if: always()
        with:
          name: CI Test Results
          path: 'build/test/**/*.trx'
          reporter: dotnet-trx

      # Publish code coverage
      - name: Publish Code Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/build/test/**/In/**/coverage.cobertura.xml'
          flags: unittests
          name: codecov-umbrella

      # Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/test/**/*.trx
          retention-days: 30

      # Upload code coverage as artifacts
      - name: Upload Code Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage
          path: '**/build/test/**/In/**/coverage.cobertura.xml'
          retention-days: 30

      # Upload build logs as artifacts
      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            build/**/*.log
            build/**/*.binlog
          retention-days: 30
          