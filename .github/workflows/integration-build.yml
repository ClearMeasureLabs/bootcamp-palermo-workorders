name: Integration Build

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  build-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      BUILD_CONFIGURATION: Release
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK 10.0.100
      - name: Setup .NET SDK 10.0.100
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'

      # Set version environment variable
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

       # Run Invoke-CIBuild script
      - name: Run CI Build Script
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          . ./build.ps1
          Invoke-CIBuild

      # Publish test results
      - name: Test Reporter
        uses: dorny/test-reporter@v2.1.1
        if: always()
        with:
          name: Linux CI Test Results
          path: 'build/test/**/*.trx'
          reporter: dotnet-trx

      # Publish code coverage
      - name: Publish Code Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/build/test/**/In/**/coverage.cobertura.xml'
          flags: unittests-linux
          name: codecov-linux

      # Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-linux
          path: build/test/**/*.trx
          retention-days: 30

      # Upload code coverage as artifacts
      - name: Upload Code Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage-linux
          path: '**/build/test/**/In/**/coverage.cobertura.xml'
          retention-days: 30

      # Package Everything as NuGet Packages
      - name: Package NuGet Packages
        shell: pwsh
        env:
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          . ./build.ps1
          Package-Everything

      # Upload packages as artifacts
      - name: Upload NuGet Packages
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nuget-packages-acceptance
          path: build/*.nupkg
          retention-days: 90


  run-acceptance-tests:
    name: Acceptance Tests and Package
    runs-on: ubuntu-latest
    needs: [build-linux]
    if: success()
    permissions:
      contents: read
      packages: write
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK 10.0.100
      - name: Setup .NET SDK 10.0.100
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'

      # Install .NET SDK 6.0 (required by Octopus CLI)
      - name: Setup .NET SDK 6.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # Set version environment variable
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      # Run Acceptance Tests
      - name: Run Acceptance Tests
        shell: pwsh
        env:
          BuildConfiguration: Release
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          .\AcceptanceTests.ps1

      # Upload test results
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-acceptance
          path: build/test/**/*.trx
          retention-days: 30
