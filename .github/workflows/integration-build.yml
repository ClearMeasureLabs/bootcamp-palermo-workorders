name: Integration Build

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  MAJOR_VERSION: 1
  MINOR_VERSION: 3

jobs:
  build-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      BUILD_CONFIGURATION: Release
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK 10.0.100
      - name: Setup .NET SDK 10.0.100
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'

      # Install .NET SDK 6.0 (required by Octopus CLI tool - includes runtime)
      - name: Setup .NET SDK 6.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # Verify .NET 6.0 runtime is available (required by dotnet-octo tool)
      - name: Verify .NET 6.0 runtime
        run: |
          echo "Installed runtimes:"
          dotnet --list-runtimes
          echo ""
          echo "Checking for .NET 6.0 runtime:"
          if dotnet --list-runtimes | grep -q "Microsoft.NETCore.App 6.0"; then
            echo "✓ .NET 6.0 runtime is available"
          else
            echo "✗ .NET 6.0 runtime not found - attempting to install runtime explicitly"
            # Try installing runtime explicitly if SDK installation didn't include it
            curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --runtime dotnet --version 6.0.0
            export PATH="$HOME/.dotnet:$PATH"
            dotnet --list-runtimes
          fi

      # Set version environment variable
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

       # Run Invoke-CIBuild script
      - name: Run CI Build Script
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          . ./build.ps1
          Invoke-CIBuild

      # Publish test results
      - name: Test Reporter
        uses: dorny/test-reporter@v2.1.1
        if: always()
        with:
          name: Linux CI Test Results
          path: 'build/test/**/*.trx'
          reporter: dotnet-trx

      # Publish code coverage
      - name: Publish Code Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/build/test/**/In/**/coverage.cobertura.xml'
          flags: unittests-linux
          name: codecov-linux

      # Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-linux
          path: build/test/**/*.trx
          retention-days: 30

      # Upload code coverage as artifacts
      - name: Upload Code Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage-linux
          path: '**/build/test/**/In/**/coverage.cobertura.xml'
          retention-days: 30

      # Package Everything as NuGet Packages
      - name: Create NuGet Packages
        shell: pwsh
        env:
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          . ./build.ps1
          Package-Everything

      # Upload packages as artifacts
      - name: Upload NuGet Packages
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nuget-packages-acceptance
          path: build/*.nupkg
          retention-days: 90

  dockerbuildandpush:
    name: Build and Push Docker Image
    needs: build-linux
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set version environment variable (same as build-linux job)
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      # Install .NET SDK 10.0.100
      - name: Setup .NET SDK 10.0.100
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'


      # Download NuGet packages from build-linux job
      - name: Download NuGet Packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages-acceptance
          path: ./packages

      # Extract ChurchBulletin.UI NuGet package
      - name: Extract UI NuGet Package
        run: |
          # Find the ChurchBulletin.UI package
          PACKAGE_FILE=$(find ./packages -name "ChurchBulletin.UI.*.nupkg" | head -n 1)
          
          if [ -z "$PACKAGE_FILE" ]; then
            echo "Error: ChurchBulletin.UI package not found"
            ls -la ./packages/
            exit 1
          fi
          
          echo "Found package: $PACKAGE_FILE"
          
          # Create temporary extraction directory
          mkdir -p ./package-extract
          
          # Extract the Octopus package (it's a ZIP file)
          unzip -q "$PACKAGE_FILE" -d ./package-extract
          
          # Create built directory (where Dockerfile expects files)
          mkdir -p ./built
          
          # Octopus packages may have files directly in root or nested
          # Look for the DLL file to determine structure
          DLL_PATH=$(find ./package-extract -name "ClearMeasure.Bootcamp.UI.Server.dll" | head -n 1)
          
          if [ -z "$DLL_PATH" ]; then
            echo "Error: ClearMeasure.Bootcamp.UI.Server.dll not found in package"
            echo "Package contents:"
            find ./package-extract -type f | head -20
            exit 1
          fi
          
          # Get the directory containing the DLL
          DLL_DIR=$(dirname "$DLL_PATH")
          
          # Copy all files from the DLL's directory to built
          # This handles both flat and nested package structures
          cp -r "$DLL_DIR"/* ./built/
          
          # Remove any package metadata files that might have been copied
          find ./built -name "*.nuspec" -delete 2>/dev/null || true
          find ./built -name "[Content_Types].xml" -delete 2>/dev/null || true
          find ./built -name "*.psmdcp" -delete 2>/dev/null || true
          
          # Verify extracted files
          echo "Extracted files in built directory:"
          ls -la built/
          
          # Verify we have the expected DLL
          if [ -f ./built/ClearMeasure.Bootcamp.UI.Server.dll ]; then
            echo "✓ Successfully extracted UI Server package"
          else
            echo "Error: ClearMeasure.Bootcamp.UI.Server.dll not found after extraction"
            exit 1
          fi
          
          # Clean up
          rm -rf ./package-extract ./packages

      # Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ env.BUILD_BUILDNUMBER }}"
          docker build -f Dockerfile -t churchbulletingithubacr.azurecr.io/churchbulletin.ui:${IMAGE_TAG} .
          docker tag churchbulletingithubacr.azurecr.io/churchbulletin.ui:${IMAGE_TAG} churchbulletingithubacr.azurecr.io/churchbulletin.ui:latest

      # Login to Azure
      - name: Login to Azure
        uses: azure/login@v1
        with:
          # TODO:  Need to create the AZURE_CREDENTIALS secret in the GitHub repository.
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Login to Azure Container Registry
      - name: Login to ACR
        run: |
          az acr login --name churchbulletingithubacr

      # Push Docker image to ACR
      - name: Push Docker image to ACR
        run: |
          IMAGE_TAG="${{ env.BUILD_BUILDNUMBER }}"
          docker push churchbulletingithubacr.azurecr.io/churchbulletin.ui:${IMAGE_TAG}
          docker push churchbulletingithubacr.azurecr.io/churchbulletin.ui:latest
          
  run-acceptance-tests:
    name: Acceptance Tests and Package
    runs-on: ubuntu-latest
    needs: [build-linux]
    if: success()
    permissions:
      contents: read
      packages: write
    
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK 10.0.100
      - name: Setup .NET SDK 10.0.100
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'

      # Install .NET SDK 6.0 (required by Octopus CLI tool - includes runtime)
      - name: Setup .NET SDK 6.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # Verify .NET 6.0 runtime is available (required by dotnet-octo tool)
      - name: Verify .NET 6.0 runtime
        run: |
          echo "Installed runtimes:"
          dotnet --list-runtimes
          echo ""
          echo "Checking for .NET 6.0 runtime:"
          if dotnet --list-runtimes | grep -q "Microsoft.NETCore.App 6.0"; then
            echo "✓ .NET 6.0 runtime is available"
          else
            echo "✗ .NET 6.0 runtime not found - attempting to install runtime explicitly"
            # Try installing runtime explicitly if SDK installation didn't include it
            curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --runtime dotnet --version 6.0.0
            export PATH="$HOME/.dotnet:$PATH"
            dotnet --list-runtimes
          fi

      # Set version environment variable
      - name: Set Version
        run: |
          version="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
          echo "BUILD_BUILDNUMBER=$version" >> $GITHUB_ENV
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "Build version: $version"

      # Run Acceptance Tests
      - name: Run Acceptance Tests
        shell: pwsh
        env:
          BuildConfiguration: Release
          BUILD_BUILDNUMBER: ${{ env.VERSION }}
        run: |
          .\AcceptanceTests.ps1

      # Upload test results
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-acceptance
          path: build/test/**/*.trx
          retention-days: 30
