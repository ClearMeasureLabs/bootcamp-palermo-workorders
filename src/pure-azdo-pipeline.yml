trigger:
  - "*"

variables:
  major: 1
  minor: 3
name: $(major).$(minor).$(Rev:r)

stages:
  - stage: "Integration_Build"
    displayName: "Build Application"

    jobs:
      - job: "Build"
        displayName: "Build job"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          # Dependencies
          - task: UseDotNet@2
            displayName: "Install SDK 9.0.302"
            inputs:
              packageType: "sdk"
              version: "9.0.302"
          - task: UseDotNet@2
            inputs:
              packageType: "runtime"
              version: "6.0.0"
          # Set environment variables
          - task: PowerShell@2
            inputs:
              targetType: "inline"
              script: |
                [System.Environment]::SetEnvironmentVariable('Version','$(Build.BuildNumber)')
                echo $env:Version
                echo $(Build.BuildNumber)
          - task: PowerShell@2
            displayName: Build_Linux.ps1
            inputs:
              targetType: filePath
              filePath: ./build_linux.ps1
              arguments: ";Invoke-Build"
          - task: PublishTestResults@2
            displayName: "Publish Test Results ./build/test/*.trx"
            inputs:
              testResultsFormat: VSTest
              testResultsFiles: "build/test/**/*.trx"
              mergeTestResults: true
              testRunTitle: "CI Tests"
            continueOnError: true
            condition: succeededOrFailed()
          - task: PublishCodeCoverageResults@1
            displayName: "Publish code coverage UnitTests"
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/build/test/**/In/**/coverage.cobertura.xml"
          - task: DotNetCoreCLI@2
            displayName: "Push NuGet packages."
            inputs:
              command: "push"
              packagesToPush: "$(System.DefaultWorkingDirectory)/build/*.nupkg"
              nuGetFeedType: "internal"
              publishVstsFeed: "$(AzureFeedName)"
      - job: "DockerBuildandPush"
        pool:
          vmImage: "ubuntu-latest"
        dependsOn: Build

        steps:
          - task: DownloadPackage@1
            displayName: "Download UI Package"
            inputs:
              packageType: "nuget"
              feed: "$(AzureFeedName)"
              view: "Local"
              definition: "ChurchBulletin.UI"
              version: "$(Build.BuildNumber)"
              downloadPath: "$(System.DefaultWorkingDirectory)/built"
              extract: true

          - task: Docker@2
            inputs:
              containerRegistry: "$(AzureContainerRegistry)"
              repository: "ChurchBulletin.UI"
              command: "buildAndPush"
              Dockerfile: "**/Dockerfile"
              tags: |
                $(Build.BuildNumber)
    #Azure junk db passwords - hsimpson123! - user is the name of the environment

  # Deploying to TDD
  - stage: "TDD"
    displayName: "TDD"
    jobs:
      - deployment: "DeployToTDD"
        pool:
          vmImage: "windows-latest"
        environment: "TDD"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPackage@1
                  displayName: "Download Database Package"
                  inputs:
                    packageType: "nuget"
                    feed: "$(AzureFeedName)"
                    view: "Local"
                    definition: "ChurchBulletin.Database"
                    version: "$(Build.BuildNumber)"
                    downloadPath: "$(System.DefaultWorkingDirectory)"
                    extract: true
                - task: PowerShell@2
                  displayName: "Create database schema"
                  inputs:
                    targetType: filePath
                    filePath: ./scripts/UpdateAzurePipelineSql.ps1
                    arguments: -DatabaseServer "$(DatabaseServer)" -DatabaseName "ChurchBulletin" -DatabaseAction "$(DatabaseAction)" -DatabaseUser "tdd" -DatabasePassword "$(DatabasePassword)"

                - task: AzureCLI@2
                  displayName: "Add revision to container app"
                  inputs:
                    azureSubscription: "$(AzureSubscription)"
                    scriptType: "ps"
                    scriptLocation: "inlineScript"
                    inlineScript: az containerapp update --name $(containerAppName) --resource-group bootcamp-tdd --image $(containerImage)

                - task: DownloadPackage@1
                  displayName: "Download Acceptance Test Package"
                  inputs:
                    packageType: "nuget"
                    feed: "$(AzureFeedName)"
                    view: "Local"
                    definition: "ChurchBulletin.AcceptanceTests"
                    version: "$(Build.Buildnumber)"
                    downloadPath: "$(System.DefaultWorkingDirectory)/tests"
                    extract: true
                - task: DownloadPackage@1
                  displayName: "Download ChurchBulletin.Database Package"
                  inputs:
                    packageType: "nuget"
                    feed: "$(AzureFeedName)"
                    view: "Local"
                    definition: "ChurchBulletin.Database"
                    version: "$(Build.Buildnumber)"
                    downloadPath: "$(System.DefaultWorkingDirectory)/database"
                    extract: true

                - task: PowerShell@2
                  displayName: "Run ChurchBulletin.Database migration"
                  inputs:
                    targetType: "inline"
                    script: |
                      $databaseDll = Get-ChildItem -Path "$(System.DefaultWorkingDirectory)/database" -Filter "ClearMeasure.Bootcamp.Database.dll" -Recurse | Select-Object -First 1
                      if ($databaseDll) {
                        dotnet $databaseDll.FullName "$(DatabaseAction)" "$(DatabaseServer)" "ChurchBulletin" "$(System.DefaultWorkingDirectory)/database/scripts"
                      } else {
                        Write-Error "ClearMeasure.Bootcamp.Database.dll not found in downloaded package"
                        exit 1
                      }

                - task: PowerShell@2
                  displayName: "Install Playwright"
                  inputs:
                    targetType: "inline"
                    script: |
                      pwsh ./tests/playwright.ps1 install --with-deps

                - task: VSTest@2
                  continueOnError: true
                  displayName: "VsTest - AcceptanceTests"
                  inputs:
                    testSelector: "testAssemblies"
                    testAssemblyVer2: |
                      **\*AcceptanceTests.dll
                      !**\*TestAdapter.dll
                      !**\obj\**
                      searchFolder: '$(System.DefaultWorkingDirectory)/tests'
                    uiTests: true
                    codeCoverageEnabled: true
                    testRunTitle: "Acceptance Tests"
                    diagnosticsEnabled: True
                    rerunFailedTestCasesMaxLimit: 3
                    rerunFailedTests: true
                    rerunMaxAttempts: 2
                    rerunType: basedOnTestFailureCount

  # Deploying to UAT
  - stage: "UAT"
    displayName: "UAT"
    condition: eq(variables['Build.Reason'], 'Manual')
    jobs:
      - deployment: "DeployToUAT"
        pool:
          vmImage: "windows-latest"
        environment: "UAT"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPackage@1
                  displayName: "Download Database Package"
                  inputs:
                    packageType: "nuget"
                    feed: "$(AzureFeedName)"
                    view: "Local"
                    definition: "ChurchBulletin.Database"
                    version: "$(Build.Build.Number)"
                    downloadPath: "$(System.DefaultWorkingDirectory)"
                    extract: true
                - task: PowerShell@2
                  displayName: "Create database schema"
                  inputs:
                    targetType: filePath
                    filePath: ./scripts/UpdateAzurePipelineSql.ps1
                    arguments: -DatabaseServer "$(DatabaseServerUAT)" -DatabaseName "ChurchBulletin" -DatabaseAction "$(DatabaseAction)" -DatabaseUser "uat" -DatabasePassword "$(DatabasePassword)"

                - task: AzureCLI@2
                  displayName: "Add revision to container app"
                  inputs:
                    azureSubscription: "$(AzureSubscription)"
                    scriptType: "ps"
                    scriptLocation: "inlineScript"
                    inlineScript: az containerapp update --name $(containerAppName) --resource-group bootcamp-uat --image $(containerImage)

  # Deploying to PROD
  - stage: "PROD"
    displayName: "PROD"
    jobs:
      - deployment: "DeployToPROD"
        pool:
          vmImage: "windows-latest"
        environment: "PROD"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPackage@1
                  displayName: "Download Database Package"
                  inputs:
                    packageType: "nuget"
                    feed: "$(AzureFeedName)"
                    view: "Local"
                    definition: "ChurchBulletin.Database"
                    version: "$(Build.BuildNumber)"
                    downloadPath: "$(System.DefaultWorkingDirectory)"
                    extract: true
                - task: PowerShell@2
                  displayName: "Create database schema"
                  inputs:
                    targetType: filePath
                    filePath: ./scripts/UpdateAzurePipelineSql.ps1
                    arguments: -DatabaseServer "$(DatabaseServerPROD)" -DatabaseName "ChurchBulletin" -DatabaseAction "$(DatabaseAction)" -DatabaseUser "prod" -DatabasePassword "$(DatabasePassword)"

                - task: AzureCLI@2
                  displayName: "Add revision to container app"
                  inputs:
                    azureSubscription: "$(AzureSubscription)"
                    scriptType: "ps"
                    scriptLocation: "inlineScript"
                    inlineScript: az containerapp update --name $(containerAppName) --resource-group bootcamp-prod --image $(containerImage)
