@using ClearMeasure.Bootcamp.Core.Queries
@using ClearMeasure.Bootcamp.UI.Shared.Pages
@implements Palermo.BlazorMvc.IListener<ClearMeasure.Bootcamp.UI.Shared.Pages.WorkOrderChangedEvent>
@inherits AppComponentBase
@inject IUserSession UserSession

My Work Orders (@Count)

@code {
    private Employee? _currentUser = null;
    private readonly HashSet<WorkOrder> _myWorkOrders = new HashSet<WorkOrder>();
    public int Count => _myWorkOrders.Count;

    public void Handle(WorkOrderChangedEvent theEvent)
    {
        WorkOrder order = theEvent.Result.WorkOrder;
        _myWorkOrders.Add(order);
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        await SetCurrentUser();
        _myWorkOrders.UnionWith(await Bus.Send(new WorkOrderSpecificationQuery() { Creator = _currentUser }));
    }

    private async Task SetCurrentUser()
    {
        _currentUser = await UserSession!.GetCurrentUserAsync();
    }

}