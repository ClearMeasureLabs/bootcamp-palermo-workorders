@implements Palermo.BlazorMvc.IListener<WorkOrderChangedEvent>
@using ClearMeasure.Bootcamp.Core.Queries
@using ClearMeasure.Bootcamp.UI.Shared.Pages
@inherits AppComponentBase
@inject IUserSession UserSession

My Work Orders (@Count)

@code {
    private Employee? _currentUser;
    private readonly HashSet<WorkOrder> _myWorkOrders = new();
    public int Count => _myWorkOrders.Count;

    public void Handle(WorkOrderChangedEvent theEvent)
    {
        var order = theEvent.Result.WorkOrder;
        _myWorkOrders.Add(order);
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        await SetCurrentUser();
        _myWorkOrders.UnionWith(await Bus.Send(new WorkOrderSpecificationQuery { Creator = _currentUser }));
    }

    private async Task SetCurrentUser()
    {
        _currentUser = await UserSession!.GetCurrentUserAsync();
    }

}